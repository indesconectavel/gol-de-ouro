#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Executando verificaÃ§Ãµes prÃ©-push..."

# Executar auditoria MCP
echo "ğŸ¤– Executando auditoria MCP..."
node cursor-mcp-command.js

if [ $? -ne 0 ]; then
  echo "âŒ Auditoria MCP falhou! Push bloqueado."
  exit 1
fi

# Executar todos os testes
echo "ğŸ§ª Executando todos os testes..."
npm run test:all

if [ $? -ne 0 ]; then
  echo "âŒ Testes falharam! Push bloqueado."
  exit 1
fi

# Verificar cobertura de testes
echo "ğŸ“Š Verificando cobertura de testes..."
npm run test:coverage

# Verificar se Ã© push para main
if [ "$1" = "refs/heads/main" ]; then
  echo "âš ï¸  Push para branch main detectado!"
  echo "ğŸ” Executando verificaÃ§Ãµes adicionais..."
  
  # Verificar se todos os arquivos crÃ­ticos existem
  echo "ğŸ“ Verificando arquivos crÃ­ticos..."
  test -f server-fly.js || { echo "âŒ server-fly.js nÃ£o encontrado!"; exit 1; }
  test -d routes || { echo "âŒ diretÃ³rio routes nÃ£o encontrado!"; exit 1; }
  test -d controllers || { echo "âŒ diretÃ³rio controllers nÃ£o encontrado!"; exit 1; }
  test -d middlewares || { echo "âŒ diretÃ³rio middlewares nÃ£o encontrado!"; exit 1; }
  
  echo "âœ… VerificaÃ§Ãµes para main concluÃ­das!"
fi

echo "âœ… VerificaÃ§Ãµes prÃ©-push concluÃ­das com sucesso!"
