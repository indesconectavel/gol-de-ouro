{
  "inicio": "2025-12-05T01:32:06.277Z",
  "versao": "V18.0.0",
  "etapas": {
    "etapa0": {
      "status": "ok",
      "arquivo": "00-CONTEXTO-SISTEMA.md"
    },
    "etapa1": {
      "inicio": "2025-12-05T01:32:06.577Z",
      "rls": {
        "tabelas": {
          "usuarios": {
            "rls_habilitado": false,
            "status": "❌"
          },
          "transacoes": {
            "rls_habilitado": false,
            "status": "❌"
          },
          "chutes": {
            "rls_habilitado": false,
            "status": "❌"
          },
          "lotes": {
            "rls_habilitado": false,
            "status": "❌"
          },
          "pagamentos_pix": {
            "rls_habilitado": false,
            "status": "❌"
          }
        },
        "problemas": [
          "RLS não habilitado na tabela usuarios",
          "RLS não habilitado na tabela transacoes",
          "RLS não habilitado na tabela chutes",
          "RLS não habilitado na tabela lotes",
          "RLS não habilitado na tabela pagamentos_pix"
        ],
        "recomendacoes": [
          "ALTER TABLE usuarios ENABLE ROW LEVEL SECURITY;",
          "ALTER TABLE transacoes ENABLE ROW LEVEL SECURITY;",
          "ALTER TABLE chutes ENABLE ROW LEVEL SECURITY;",
          "ALTER TABLE lotes ENABLE ROW LEVEL SECURITY;",
          "ALTER TABLE pagamentos_pix ENABLE ROW LEVEL SECURITY;"
        ]
      },
      "indices": {
        "indices": {
          "idx_chutes_usuario_id": "❌",
          "idx_chutes_lote_id": "❌",
          "idx_chutes_created_at": "❌",
          "idx_transacoes_usuario_id": "❌",
          "idx_transacoes_created_at": "❌",
          "idx_lotes_status": "❌",
          "idx_lotes_valor_aposta": "❌",
          "idx_usuarios_email": "❌"
        },
        "faltando": [
          {
            "tabela": "chutes",
            "coluna": "usuario_id",
            "nome": "idx_chutes_usuario_id"
          },
          {
            "tabela": "chutes",
            "coluna": "lote_id",
            "nome": "idx_chutes_lote_id"
          },
          {
            "tabela": "chutes",
            "coluna": "created_at",
            "nome": "idx_chutes_created_at"
          },
          {
            "tabela": "transacoes",
            "coluna": "usuario_id",
            "nome": "idx_transacoes_usuario_id"
          },
          {
            "tabela": "transacoes",
            "coluna": "created_at",
            "nome": "idx_transacoes_created_at"
          },
          {
            "tabela": "lotes",
            "coluna": "status",
            "nome": "idx_lotes_status"
          },
          {
            "tabela": "lotes",
            "coluna": "valor_aposta",
            "nome": "idx_lotes_valor_aposta"
          },
          {
            "tabela": "usuarios",
            "coluna": "email",
            "nome": "idx_usuarios_email"
          }
        ],
        "recomendacoes": [
          "CREATE INDEX IF NOT EXISTS idx_chutes_usuario_id ON chutes(usuario_id);",
          "CREATE INDEX IF NOT EXISTS idx_chutes_lote_id ON chutes(lote_id);",
          "CREATE INDEX IF NOT EXISTS idx_chutes_created_at ON chutes(created_at);",
          "CREATE INDEX IF NOT EXISTS idx_transacoes_usuario_id ON transacoes(usuario_id);",
          "CREATE INDEX IF NOT EXISTS idx_transacoes_created_at ON transacoes(created_at);",
          "CREATE INDEX IF NOT EXISTS idx_lotes_status ON lotes(status);",
          "CREATE INDEX IF NOT EXISTS idx_lotes_valor_aposta ON lotes(valor_aposta);",
          "CREATE INDEX IF NOT EXISTS idx_usuarios_email ON usuarios(email);"
        ]
      },
      "queriesLentas": {
        "queries": [],
        "recomendacoes": [
          "Instalar extensão pg_stat_statements para análise detalhada:",
          "CREATE EXTENSION IF NOT EXISTS pg_stat_statements;",
          "",
          "Consultar queries lentas:",
          "SELECT query, calls, total_time, mean_time FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;"
        ]
      },
      "raceConditions": {
        "riscos": [
          {
            "tipo": "Chutes simultâneos",
            "descricao": "Múltiplos chutes podem ser processados simultaneamente no mesmo lote",
            "mitigacao": "Usar SELECT FOR UPDATE ao obter lote"
          },
          {
            "tipo": "Atualização de saldo",
            "descricao": "Múltiplas transações podem atualizar saldo simultaneamente",
            "mitigacao": "Usar RPC functions com locks (já implementado)"
          }
        ],
        "recomendacoes": [
          "✅ RPC functions já implementadas com locks",
          "✅ FinancialService usa rpc_add_balance e rpc_deduct_balance",
          "⚠️ Verificar se getOrCreateLote usa SELECT FOR UPDATE"
        ]
      },
      "corrupcaoMemoria": {
        "riscos": [
          {
            "tipo": "Lotes em memória",
            "descricao": "Lotes armazenados em Map() podem ser perdidos em reinicialização",
            "status": "⚠️ Mitigado parcialmente",
            "detalhes": "Sincronização ao iniciar, mas estado pode divergir"
          }
        ],
        "recomendacoes": [
          "✅ Sincronização implementada via syncActiveLotes()",
          "⚠️ Considerar migrar lotes completamente para banco",
          "⚠️ Implementar heartbeat para validar estado"
        ]
      },
      "erros": [],
      "fim": "2025-12-05T01:32:07.822Z"
    },
    "etapa2": {
      "status": "ok",
      "nota": "Implementação requer criação de endpoint /monitor e dashboard React"
    },
    "etapa3": {
      "status": "ok",
      "nota": "Script v18-auditoria-continuada.js criado para execução a cada 5 minutos"
    },
    "etapa4": {
      "status": "ok",
      "arquivos": [
        "SISTEMA-LOTE-ATUAL.md",
        "SISTEMA-CHUTE-ATUAL.md",
        "SISTEMA-PREMIACAO-ATUAL.md"
      ]
    },
    "etapa5": {
      "inicio": "2025-12-05T01:32:07.824Z",
      "chutes": [
        {
          "index": 1,
          "status": 200,
          "latencia": 513,
          "success": true
        },
        {
          "index": 2,
          "status": 200,
          "latencia": 509,
          "success": true
        },
        {
          "index": 3,
          "status": 200,
          "latencia": 186,
          "success": true
        },
        {
          "index": 4,
          "status": 200,
          "latencia": 166,
          "success": true
        },
        {
          "index": 5,
          "status": 200,
          "latencia": 205,
          "success": true
        },
        {
          "index": 6,
          "status": 200,
          "latencia": 292,
          "success": true
        },
        {
          "index": 7,
          "status": 200,
          "latencia": 562,
          "success": true
        },
        {
          "index": 8,
          "status": 200,
          "latencia": 154,
          "success": true
        },
        {
          "index": 9,
          "status": 200,
          "latencia": 161,
          "success": true
        },
        {
          "index": 10,
          "status": 200,
          "latencia": 280,
          "success": true
        }
      ],
      "lotes": [],
      "latencias": [
        513,
        509,
        186,
        166,
        205,
        292,
        562,
        154,
        161,
        280
      ],
      "erros": [],
      "fim": "2025-12-05T01:32:17.341Z",
      "latenciaMedia": 302.8,
      "sucesso": 10
    },
    "etapa6": {
      "versao": "V18.0.0",
      "data": "2025-12-05",
      "resumo": {
        "contexto": "✅ Documentado",
        "hardening": "✅ Verificado",
        "observabilidade": "⚠️ Requer implementação",
        "auditoriaContinua": "✅ Script criado",
        "extracaoSistema": "✅ Documentado",
        "diagnostico": "✅ Executado"
      },
      "melhorias": [
        "RLS não habilitado em todas as tabelas",
        "Faltam índices em algumas colunas críticas",
        "Observabilidade requer endpoint /monitor",
        "Auditoria contínua requer cron job"
      ],
      "roadmapV19": [
        "Habilitar RLS em todas as tabelas",
        "Criar índices faltantes",
        "Implementar endpoint /monitor",
        "Criar dashboard React de observabilidade",
        "Configurar auditoria contínua automática"
      ]
    }
  },
  "scores": {},
  "erros": [],
  "warnings": [],
  "fim": "2025-12-05T01:32:17.342Z",
  "duracao": 11065
}