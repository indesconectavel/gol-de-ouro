name: üîç Health Monitor ‚Äì Gol de Ouro

on:
  schedule:
    - cron: "*/15 * * * *" # Executa a cada 15 minutos
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Verificar backend (Fly.io)
        run: |
          echo "Verificando backend..."
          STATUS_BACKEND=$(curl -s -o /dev/null -w "%{http_code}" https://goldeouro-backend.fly.dev/health)
          echo "Backend HTTP: $STATUS_BACKEND"
          if [ "$STATUS_BACKEND" != "200" ]; then
            echo "‚ùå Backend fora do ar"
            echo "Backend status: $STATUS_BACKEND" >> docs/logs/health-fails.log
            echo "‚ö†Ô∏è Backend OFFLINE - $(date)" >> docs/logs/health-summary.log
            echo "::error::Backend offline"
          else
            echo "‚úÖ Backend online"
            echo "‚úÖ Backend ONLINE - $(date)" >> docs/logs/health-summary.log
          fi

      - name: Verificar frontend (Vercel)
        run: |
          echo "Verificando frontend..."
          STATUS_FRONT=$(curl -s -o /dev/null -w "%{http_code}" https://goldeouro.lol)
          echo "Frontend HTTP: $STATUS_FRONT"
          if [ "$STATUS_FRONT" != "200" ]; then
            echo "‚ùå Frontend fora do ar"
            echo "Frontend status: $STATUS_FRONT" >> docs/logs/health-fails.log
            echo "‚ö†Ô∏è Frontend OFFLINE - $(date)" >> docs/logs/health-summary.log
            echo "::error::Frontend offline"
          else
            echo "‚úÖ Frontend online"
            echo "‚úÖ Frontend ONLINE - $(date)" >> docs/logs/health-summary.log
          fi

      - name: Verificar banco de dados (Supabase)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "Verificando banco de dados..."
          if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_KEY" ]; then
            curl -s -H "apikey: $SUPABASE_KEY" "$SUPABASE_URL/rest/v1" > /dev/null
            if [ $? -ne 0 ]; then
              echo "‚ùå Supabase inacess√≠vel"
              echo "‚ö†Ô∏è Supabase OFFLINE - $(date)" >> docs/logs/health-summary.log
              echo "::error::Supabase offline"
            else
              echo "‚úÖ Banco de dados operacional"
              echo "‚úÖ Supabase ONLINE - $(date)" >> docs/logs/health-summary.log
            fi
          else
            echo "‚ö†Ô∏è Credenciais Supabase n√£o configuradas"
            echo "‚ö†Ô∏è Supabase SKIP - $(date)" >> docs/logs/health-summary.log
          fi

      - name: Gerar relat√≥rio di√°rio de sa√∫de
        run: |
          echo "üìä Relat√≥rio de monitoramento - $(date)" > docs/RELATORIO-HEALTH-MONITOR.md
          echo "" >> docs/RELATORIO-HEALTH-MONITOR.md
          echo "√öltimas verifica√ß√µes:" >> docs/RELATORIO-HEALTH-MONITOR.md
          if [ -f "docs/logs/health-summary.log" ]; then
            tail -n 20 docs/logs/health-summary.log >> docs/RELATORIO-HEALTH-MONITOR.md
          else
            echo "Nenhuma verifica√ß√£o anterior encontrada" >> docs/RELATORIO-HEALTH-MONITOR.md
          fi

      - name: Commitar relat√≥rios
        run: |
          git config --global user.email "ci@goldeouro.dev"
          git config --global user.name "CI Pipeline"
          git add docs/logs/ docs/RELATORIO-HEALTH-MONITOR.md
          git commit -m "üìä Atualiza√ß√£o autom√°tica ‚Äì Health Monitor $(date)" || echo "Nenhuma mudan√ßa para commitar"
          git push origin main || echo "Push falhou ou n√£o h√° mudan√ßas"

      - name: Enviar alerta (Slack/Discord)
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
            --data "{\"content\":\"‚ö†Ô∏è *Gol de Ouro alerta:* Um dos servi√ßos est√° offline! Verifique o pipeline no GitHub Actions.\"}" \
            $DISCORD_WEBHOOK_URL || true
          fi
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"‚ö†Ô∏è Gol de Ouro alerta: Um dos servi√ßos est√° offline! Verifique o pipeline no GitHub Actions.\"}" \
            $SLACK_WEBHOOK_URL || true
          fi
