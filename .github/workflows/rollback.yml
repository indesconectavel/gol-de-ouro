name: ‚ö†Ô∏è Rollback Autom√°tico ‚Äì Gol de Ouro

on:
  workflow_run:
    workflows: ["üöÄ Pipeline Principal - Gol de Ouro"]
    types:
      - completed

jobs:
  rollback:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: üîÑ Checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 1

      - name: ‚öôÔ∏è Configurar Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: ‚öôÔ∏è Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üîÅ Rollback Backend (Fly.io)
        continue-on-error: true
        run: |
          echo "‚ö†Ô∏è Deploy do backend falhou. Iniciando rollback..."
          if [ -z "${{ secrets.FLY_API_TOKEN }}" ]; then
            echo "‚ö†Ô∏è FLY_API_TOKEN n√£o configurado. Pulando rollback do backend."
            exit 0
          fi
          
          # Listar releases dispon√≠veis
          RELEASES=$(flyctl releases --app goldeouro-backend-v2 --json 2>/dev/null || echo "[]")
          if [ "$RELEASES" = "[]" ] || [ -z "$RELEASES" ]; then
            echo "‚ö†Ô∏è Nenhum release anterior encontrado. Rollback n√£o poss√≠vel."
            exit 0
          fi
          
          # Obter pen√∫ltimo release (√∫ltimo √© o que falhou)
          LAST_RELEASE=$(echo "$RELEASES" | jq -r '.[1].version // .[0].version' 2>/dev/null || echo "")
          if [ -z "$LAST_RELEASE" ] || [ "$LAST_RELEASE" = "null" ]; then
            echo "‚ö†Ô∏è N√£o foi poss√≠vel determinar release anterior. Rollback n√£o poss√≠vel."
            exit 0
          fi
          
          echo "üîÑ Fazendo rollback para release: $LAST_RELEASE"
          flyctl releases rollback $LAST_RELEASE --app goldeouro-backend-v2 || {
            echo "‚ö†Ô∏è Rollback autom√°tico falhou. Verificar manualmente."
            exit 0
          }
          echo "‚úÖ Rollback do backend conclu√≠do com sucesso."
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: üîÅ Rollback Frontend (Vercel)
        continue-on-error: true
        run: |
          echo "‚ö†Ô∏è Deploy do frontend falhou. Revertendo para vers√£o anterior..."
          
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ] || [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            echo "‚ö†Ô∏è VERCEL_TOKEN ou VERCEL_PROJECT_ID n√£o configurado. Pulando rollback do frontend."
            exit 0
          fi
          
          # Listar deployments recentes
          DEPLOYMENTS=$(npx vercel ls ${{ secrets.VERCEL_PROJECT_ID }} --token=${{ secrets.VERCEL_TOKEN }} --json 2>/dev/null || echo "[]")
          
          if [ "$DEPLOYMENTS" = "[]" ] || [ -z "$DEPLOYMENTS" ]; then
            echo "‚ö†Ô∏è Nenhum deployment anterior encontrado. Rollback n√£o poss√≠vel."
            exit 0
          fi
          
          # Obter pen√∫ltimo deployment (√∫ltimo √© o que falhou)
          PREVIOUS_DEPLOYMENT=$(echo "$DEPLOYMENTS" | jq -r '.[1].uid // .[0].uid' 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_DEPLOYMENT" ] || [ "$PREVIOUS_DEPLOYMENT" = "null" ]; then
            echo "‚ö†Ô∏è N√£o foi poss√≠vel determinar deployment anterior. Rollback n√£o poss√≠vel."
            exit 0
          fi
          
          echo "üîÑ Fazendo rollback para deployment: $PREVIOUS_DEPLOYMENT"
          
          # Promover deployment anterior para produ√ß√£o
          npx vercel promote $PREVIOUS_DEPLOYMENT --token=${{ secrets.VERCEL_TOKEN }} --yes 2>/dev/null || {
            echo "‚ö†Ô∏è Rollback autom√°tico do frontend falhou. Verificar manualmente no Vercel Dashboard."
            exit 0
          }
          
          echo "‚úÖ Rollback do frontend conclu√≠do com sucesso."

      - name: üßæ Registrar logs
        continue-on-error: true
        run: |
          mkdir -p docs/logs
          touch docs/logs/rollback-history.log
          echo "Rollback executado em $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> docs/logs/rollback-history.log
          echo "Workflow com falha: ${{ github.event.workflow_run.name }}" >> docs/logs/rollback-history.log
          echo "Conclus√£o: ${{ github.event.workflow_run.conclusion }}" >> docs/logs/rollback-history.log
          echo "Commit: ${{ github.event.workflow_run.head_sha }}" >> docs/logs/rollback-history.log
          echo "Branch: ${{ github.event.workflow_run.head_branch }}" >> docs/logs/rollback-history.log
          echo "---" >> docs/logs/rollback-history.log
          echo "‚úÖ Logs registrados com sucesso"

      - name: üì¢ Notificar via Slack/Discord (opcional)
        if: env.SLACK_WEBHOOK_URL != ''
        continue-on-error: true
        run: |
          echo "üì¢ Enviando notifica√ß√£o de rollback..."
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"‚ö†Ô∏è ROLLBACK EXECUTADO: Pipeline principal falhou e foi revertido automaticamente"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }} || echo "‚ö†Ô∏è Falha ao enviar notifica√ß√£o Slack"
          
      - name: üì¢ Notificar via Discord (opcional)
        if: env.DISCORD_WEBHOOK_URL != ''
        continue-on-error: true
        run: |
          echo "üì¢ Enviando notifica√ß√£o Discord..."
          curl -X POST -H 'Content-type: application/json' \
            --data '{"content":"‚ö†Ô∏è **ROLLBACK EXECUTADO**\nPipeline principal falhou e foi revertido automaticamente"}' \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || echo "‚ö†Ô∏è Falha ao enviar notifica√ß√£o Discord"

      - name: üìä Upload logs de rollback
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: rollback-logs-${{ github.run_number }}
          path: docs/logs/rollback-history.log
          retention-days: 30
          if-no-files-found: ignore  # ‚úÖ N√£o falhar se arquivo n√£o existir
