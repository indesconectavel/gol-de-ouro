name: ğŸš€ Pipeline Principal - Gol de Ouro

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permitir execuÃ§Ã£o manual

env:
  NODE_VERSION: '20'
  FLY_APP_NAME: goldeouro-backend
  VERCEL_PROJECT_ID: goldeouro-player

jobs:
  # ğŸ” AnÃ¡lise e ValidaÃ§Ã£o
  analyze:
    name: ğŸ” AnÃ¡lise e ValidaÃ§Ã£o
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          cd goldeouro-player && npm ci
          echo "âœ… DependÃªncias instaladas"
          
      - name: ğŸ” AnÃ¡lise de cÃ³digo
        run: |
          echo "ğŸ” Analisando qualidade do cÃ³digo..."
          npm run lint || echo "âš ï¸ Problemas de linting encontrados"
          
      - name: ğŸ” AnÃ¡lise de seguranÃ§a
        run: |
          echo "ğŸ” Analisando seguranÃ§a..."
          npm audit --audit-level=moderate || echo "âš ï¸ Vulnerabilidades encontradas"
          
      - name: ğŸ” VerificaÃ§Ã£o de estrutura
        run: |
          echo "ğŸ” Verificando estrutura do projeto..."
          if [ -f "server-fly.js" ] && [ -f "package.json" ] && [ -f "fly.toml" ]; then
            echo "âœ… Estrutura backend vÃ¡lida"
          else
            echo "âŒ Estrutura backend invÃ¡lida"
            exit 1
          fi
          
          if [ -d "goldeouro-player" ] && [ -f "goldeouro-player/package.json" ]; then
            echo "âœ… Estrutura frontend vÃ¡lida"
          else
            echo "âŒ Estrutura frontend invÃ¡lida"
            exit 1
          fi

  # ğŸ§ª Testes
  test:
    name: ğŸ§ª Testes
    runs-on: ubuntu-latest
    needs: analyze
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          echo "âœ… DependÃªncias instaladas"
          
      - name: ğŸ§ª Executar testes unitÃ¡rios
        run: |
          echo "ğŸ§ª Executando testes unitÃ¡rios..."
          npm run test:unit || echo "âš ï¸ Alguns testes unitÃ¡rios falharam"
          
      - name: ğŸ§ª Executar testes de integraÃ§Ã£o
        run: |
          echo "ğŸ§ª Executando testes de integraÃ§Ã£o..."
          npm run test:integration || echo "âš ï¸ Alguns testes de integraÃ§Ã£o falharam"
          
      - name: ğŸ§ª Executar testes de seguranÃ§a
        run: |
          echo "ğŸ§ª Executando testes de seguranÃ§a..."
          npm run test:security || echo "âš ï¸ Alguns testes de seguranÃ§a falharam"
          
      - name: ğŸ§ª Executar testes de performance
        run: |
          echo "ğŸ§ª Executando testes de performance..."
          npm run test:performance || echo "âš ï¸ Alguns testes de performance falharam"

  # ğŸš€ Deploy Backend
  deploy-backend:
    name: ğŸš€ Deploy Backend
    runs-on: ubuntu-latest
    needs: [analyze, test]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          echo "âœ… DependÃªncias instaladas"
          
      - name: ğŸ” Configurar Fly.io
        uses: superfly/flyctl-actions/setup-flyctl@master
        
      - name: ğŸš€ Deploy para Fly.io
        run: |
          echo "ğŸš€ Iniciando deploy do backend..."
          flyctl deploy --remote-only --no-cache
          echo "âœ… Deploy do backend concluÃ­do"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          
      - name: ğŸ§ª Teste de saÃºde backend
        run: |
          echo "ğŸ§ª Testando saÃºde do backend..."
          sleep 30  # Aguardar deploy
          curl -f https://${{ env.FLY_APP_NAME }}.fly.dev/health || exit 1
          echo "âœ… Backend saudÃ¡vel"

  # ğŸ¨ Deploy Frontend
  deploy-frontend:
    name: ğŸ¨ Deploy Frontend
    runs-on: ubuntu-latest
    needs: [analyze, test]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: goldeouro-player/package-lock.json
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          cd goldeouro-player
          npm ci
          echo "âœ… DependÃªncias instaladas"
          
      - name: ğŸ” Configurar Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: goldeouro-player
          vercel-args: '--prod'
          
      - name: ğŸ§ª Teste de saÃºde frontend
        run: |
          echo "ğŸ§ª Testando saÃºde do frontend..."
          sleep 30  # Aguardar deploy
          curl -f https://goldeouro.lol || exit 1
          echo "âœ… Frontend saudÃ¡vel"

  # ğŸ“Š Monitoramento PÃ³s-Deploy
  monitor:
    name: ğŸ“Š Monitoramento
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ” Verificar saÃºde dos serviÃ§os
        run: |
          echo "ğŸ” Verificando saÃºde dos serviÃ§os..."
          
          # Backend
          backend_status=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.FLY_APP_NAME }}.fly.dev/health)
          if [ "$backend_status" = "200" ]; then
            echo "âœ… Backend: SaudÃ¡vel"
          else
            echo "âŒ Backend: Problemas (HTTP $backend_status)"
          fi
          
          # Frontend
          frontend_status=$(curl -s -o /dev/null -w "%{http_code}" https://goldeouro.lol)
          if [ "$frontend_status" = "200" ]; then
            echo "âœ… Frontend: SaudÃ¡vel"
          else
            echo "âŒ Frontend: Problemas (HTTP $frontend_status)"
          fi
          
      - name: ğŸ“Š Coletar mÃ©tricas
        run: |
          echo "ğŸ“Š Coletando mÃ©tricas..."
          curl -s https://${{ env.FLY_APP_NAME }}.fly.dev/api/metrics | jq '.' || echo "âš ï¸ NÃ£o foi possÃ­vel obter mÃ©tricas"
          
      - name: ğŸ“¢ Notificar resultado
        run: |
          echo "ğŸ“¢ Pipeline concluÃ­do!"
          echo "ğŸŒ Backend: https://${{ env.FLY_APP_NAME }}.fly.dev"
          echo "ğŸŒ Frontend: https://goldeouro.lol"
          echo "ğŸ“Š Status: ${{ job.status }}"

  # ğŸ”„ Deploy Desenvolvimento
  deploy-dev:
    name: ğŸ”„ Deploy Dev
    runs-on: ubuntu-latest
    needs: [analyze, test]
    if: github.ref == 'refs/heads/dev'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          echo "âœ… DependÃªncias instaladas"
          
      - name: ğŸ” Configurar Fly.io (Dev)
        uses: superfly/flyctl-actions/setup-flyctl@master
        
      - name: ğŸš€ Deploy para desenvolvimento
        run: |
          echo "ğŸ”„ Deploy para ambiente de desenvolvimento..."
          flyctl deploy --remote-only --no-cache
          echo "âœ… Deploy de desenvolvimento concluÃ­do"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          
      - name: ğŸ“¢ Notificar deploy dev
        run: |
          echo "ğŸ”„ Deploy de desenvolvimento concluÃ­do!"
          echo "ğŸŒ URL: https://${{ env.FLY_APP_NAME }}.fly.dev"
          echo "ğŸ“Š Status: Ambiente de desenvolvimento"
