name: ğŸ§ª Testes Automatizados

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Executar diariamente Ã s 2h

env:
  NODE_VERSION: '20'

jobs:
  # ğŸ§ª Testes Backend
  test-backend:
    name: ğŸ§ª Testes Backend
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            goldeouro-player/package-lock.json
          
      - name: ğŸ“¦ Instalar dependÃªncias
        continue-on-error: true
        run: |
          npm ci || echo "âš ï¸ Falha ao instalar dependÃªncias"
          echo "âœ… DependÃªncias instaladas"
          
      - name: ğŸ§ª Testes unitÃ¡rios backend
        continue-on-error: true
        run: |
          echo "ğŸ§ª Executando testes unitÃ¡rios..."
          if [ -f "tests/unit/backend.test.js" ]; then
            npm run test:unit
          else
            echo "âš ï¸ Testes unitÃ¡rios nÃ£o encontrados"
          fi
          
      - name: ğŸ§ª Testes de integraÃ§Ã£o
        continue-on-error: true
        run: |
          echo "ğŸ§ª Executando testes de integraÃ§Ã£o..."
          if [ -f "tests/integration/api.test.js" ]; then
            npm run test:integration || echo "âš ï¸ Testes de integraÃ§Ã£o falharam"
          else
            echo "âš ï¸ Testes de integraÃ§Ã£o nÃ£o encontrados"
          fi
          
      - name: ğŸ§ª Testes de API
        continue-on-error: true
        run: |
          echo "ğŸ§ª Executando testes de API..."
          if [ -f "tests/api/endpoints.test.js" ]; then
            npm run test:api || echo "âš ï¸ Testes de API falharam"
          else
            echo "âš ï¸ Testes de API nÃ£o encontrados"
          fi
          
      - name: ğŸ“Š Cobertura de testes
        continue-on-error: true
        run: |
          echo "ğŸ“Š Gerando relatÃ³rio de cobertura..."
          if [ -f "tests/coverage.js" ]; then
            npm run test:coverage || echo "âš ï¸ RelatÃ³rio de cobertura falhou"
          else
            echo "âš ï¸ RelatÃ³rio de cobertura nÃ£o configurado"
          fi

      - name: ğŸ“Š Upload relatÃ³rio de testes
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-report-${{ github.run_number }}
          path: |
            test-results/
            coverage/
            test-report.md
          retention-days: 7

  # ğŸ§ª Testes Frontend
  test-frontend:
    name: ğŸ§ª Testes Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            goldeouro-player/package-lock.json
          
      - name: ğŸ“¦ Instalar dependÃªncias
        continue-on-error: true
        run: |
          cd goldeouro-player
          npm ci || echo "âš ï¸ Falha ao instalar dependÃªncias do frontend"
          echo "âœ… DependÃªncias instaladas"
          
      - name: ğŸ§ª Testes unitÃ¡rios frontend
        continue-on-error: true
        run: |
          cd goldeouro-player
          echo "ğŸ§ª Executando testes unitÃ¡rios..."
          if [ -f "tests/unit/components.test.js" ]; then
            npm run test:unit
          else
            echo "âš ï¸ Testes unitÃ¡rios nÃ£o encontrados"
          fi
          
      - name: ğŸ§ª Testes de componentes
        run: |
          cd goldeouro-player
          echo "ğŸ§ª Executando testes de componentes..."
          if [ -f "tests/components/Game.test.js" ]; then
            npm run test:components
          else
            echo "âš ï¸ Testes de componentes nÃ£o encontrados"
          fi
          
      - name: ğŸ§ª Testes E2E
        run: |
          cd goldeouro-player
          echo "ğŸ§ª Executando testes E2E..."
          if [ -f "tests/e2e/game-flow.test.js" ]; then
            npm run test:e2e
          else
            echo "âš ï¸ Testes E2E nÃ£o encontrados"
          fi

  # ğŸ§ª Testes de SeguranÃ§a
  security-tests:
    name: ğŸ”’ Testes de SeguranÃ§a
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            goldeouro-player/package-lock.json
          
      - name: ğŸ“¦ Instalar dependÃªncias
        continue-on-error: true
        run: |
          npm ci || echo "âš ï¸ Falha ao instalar dependÃªncias do backend"
          cd goldeouro-player && npm ci || echo "âš ï¸ Falha ao instalar dependÃªncias do frontend"
          echo "âœ… DependÃªncias instaladas"
          
      - name: ğŸ” AnÃ¡lise de vulnerabilidades
        continue-on-error: true
        run: |
          echo "ğŸ” Analisando vulnerabilidades backend..."
          npm audit --audit-level=moderate
          
          echo "ğŸ” Analisando vulnerabilidades frontend..."
          cd goldeouro-player
          npm audit --audit-level=moderate
          
      - name: ğŸ” AnÃ¡lise de dependÃªncias
        run: |
          echo "ğŸ” Analisando dependÃªncias..."
          npx audit-ci --config audit-ci.json || echo "âš ï¸ Vulnerabilidades encontradas"
          
      - name: ğŸ” VerificaÃ§Ã£o de secrets
        run: |
          echo "ğŸ” Verificando secrets expostos..."
          if command -v truffleHog &> /dev/null; then
            truffleHog --no-verification --regex --entropy=False .
          else
            echo "âš ï¸ TruffleHog nÃ£o instalado"
          fi

  # ğŸ§ª Testes de Performance
  performance-tests:
    name: âš¡ Testes de Performance
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            goldeouro-player/package-lock.json
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          echo "âœ… DependÃªncias instaladas"
          
      - name: âš¡ Testes de carga
        run: |
          echo "âš¡ Executando testes de carga..."
          if [ -f "tests/performance/load.test.js" ]; then
            npm run test:load
          else
            echo "âš ï¸ Testes de carga nÃ£o encontrados"
          fi
          
      - name: âš¡ Testes de stress
        run: |
          echo "âš¡ Executando testes de stress..."
          if [ -f "tests/performance/stress.test.js" ]; then
            npm run test:stress
          else
            echo "âš ï¸ Testes de stress nÃ£o encontrados"
          fi
          
      - name: ğŸ“Š AnÃ¡lise de performance
        run: |
          echo "ğŸ“Š Analisando performance..."
          if command -v lighthouse &> /dev/null; then
            lighthouse https://goldeouro.lol --output=json --output-path=./lighthouse-report.json
          else
            echo "âš ï¸ Lighthouse nÃ£o instalado"
          fi

  # ğŸ“Š RelatÃ³rio de Testes
  test-report:
    name: ğŸ“Š RelatÃ³rio de Testes
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [test-backend, test-frontend, security-tests, performance-tests]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ“Š Gerar relatÃ³rio
        run: |
          echo "ğŸ“Š Gerando relatÃ³rio de testes..."
          echo "## ğŸ“Š RelatÃ³rio de Testes - $(date)" >> test-report.md
          echo "" >> test-report.md
          echo "### ğŸ§ª Status dos Testes:" >> test-report.md
          echo "- Backend: ${{ needs.test-backend.result }}" >> test-report.md
          echo "- Frontend: ${{ needs.test-frontend.result }}" >> test-report.md
          echo "- SeguranÃ§a: ${{ needs.security-tests.result }}" >> test-report.md
          echo "- Performance: ${{ needs.performance-tests.result }}" >> test-report.md
          echo "" >> test-report.md
          echo "### ğŸ“ˆ MÃ©tricas:" >> test-report.md
          echo "- Data: $(date)" >> test-report.md
          echo "- Branch: ${{ github.ref_name }}" >> test-report.md
          echo "- Commit: ${{ github.sha }}" >> test-report.md
          
      - name: ğŸ“¤ Upload relatÃ³rio
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test-report.md
          retention-days: 30
