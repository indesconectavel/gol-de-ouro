name: ðŸ”’ SeguranÃ§a e Qualidade

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * 1,3,5'  # Executar 3x por semana (segunda, quarta, sexta) - OTIMIZADO PARA REDUZIR CUSTOS

env:
  NODE_VERSION: '20'

jobs:
  # ðŸ”’ AnÃ¡lise de SeguranÃ§a
  security-analysis:
    name: ðŸ”’ AnÃ¡lise de SeguranÃ§a
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          cd goldeouro-player && npm ci
          echo "âœ… DependÃªncias instaladas"
          
      - name: ðŸ” CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          
      - name: ðŸ” CodeQL Autobuild
        uses: github/codeql-action/autobuild@v3
        
      - name: ðŸ” CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        
      - name: ðŸ” AnÃ¡lise de vulnerabilidades
        run: |
          echo "ðŸ” Analisando vulnerabilidades..."
          npm audit --audit-level=moderate
          cd goldeouro-player
          npm audit --audit-level=moderate
          
      - name: ðŸ” VerificaÃ§Ã£o de secrets
        run: |
          echo "ðŸ” Verificando secrets expostos..."
          if command -v truffleHog &> /dev/null; then
            truffleHog --no-verification --regex --entropy=False .
          else
            echo "âš ï¸ TruffleHog nÃ£o instalado"
          fi
          
      - name: ðŸ” AnÃ¡lise de dependÃªncias
        run: |
          echo "ðŸ” Analisando dependÃªncias..."
          npx audit-ci --config audit-ci.json || echo "âš ï¸ Vulnerabilidades encontradas"

  # ðŸ“Š AnÃ¡lise de Qualidade
  quality-analysis:
    name: ðŸ“Š AnÃ¡lise de Qualidade
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          cd goldeouro-player && npm ci
          echo "âœ… DependÃªncias instaladas"
          
      - name: ðŸ” ESLint Backend
        run: |
          echo "ðŸ” Executando ESLint no backend..."
          if [ -f ".eslintrc.js" ]; then
            npx eslint . --ext .js --max-warnings 0
          else
            echo "âš ï¸ ESLint nÃ£o configurado"
          fi
          
      - name: ðŸ” ESLint Frontend
        run: |
          cd goldeouro-player
          echo "ðŸ” Executando ESLint no frontend..."
          if [ -f ".eslintrc.js" ]; then
            npx eslint src/ --ext .js,.jsx,.ts,.tsx --max-warnings 0
          else
            echo "âš ï¸ ESLint nÃ£o configurado"
          fi
          
      - name: ðŸ” Prettier
        run: |
          echo "ðŸ” Verificando formataÃ§Ã£o..."
          if [ -f ".prettierrc" ]; then
            npx prettier --check .
            cd goldeouro-player
            npx prettier --check src/
          else
            echo "âš ï¸ Prettier nÃ£o configurado"
          fi
          
      - name: ðŸ” TypeScript Check
        run: |
          cd goldeouro-player
          echo "ðŸ” Verificando TypeScript..."
          if [ -f "tsconfig.json" ]; then
            npx tsc --noEmit
          else
            echo "âš ï¸ TypeScript nÃ£o configurado"
          fi

  # ðŸ§ª Testes de SeguranÃ§a
  security-tests:
    name: ðŸ§ª Testes de SeguranÃ§a
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          echo "âœ… DependÃªncias instaladas"
          
      - name: ðŸ§ª Testes de autenticaÃ§Ã£o
        run: |
          echo "ðŸ§ª Testando autenticaÃ§Ã£o..."
          if [ -f "tests/security/auth.test.js" ]; then
            npm run test:security:auth
          else
            echo "âš ï¸ Testes de autenticaÃ§Ã£o nÃ£o encontrados"
          fi
          
      - name: ðŸ§ª Testes de autorizaÃ§Ã£o
        run: |
          echo "ðŸ§ª Testando autorizaÃ§Ã£o..."
          if [ -f "tests/security/authorization.test.js" ]; then
            npm run test:security:authz
          else
            echo "âš ï¸ Testes de autorizaÃ§Ã£o nÃ£o encontrados"
          fi
          
      - name: ðŸ§ª Testes de validaÃ§Ã£o
        run: |
          echo "ðŸ§ª Testando validaÃ§Ã£o de dados..."
          if [ -f "tests/security/validation.test.js" ]; then
            npm run test:security:validation
          else
            echo "âš ï¸ Testes de validaÃ§Ã£o nÃ£o encontrados"
          fi

  # ðŸ“Š RelatÃ³rio de SeguranÃ§a
  security-report:
    name: ðŸ“Š RelatÃ³rio de SeguranÃ§a
    runs-on: ubuntu-latest
    needs: [security-analysis, quality-analysis, security-tests]
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ðŸ“Š Gerar relatÃ³rio
        run: |
          echo "ðŸ“Š Gerando relatÃ³rio de seguranÃ§a..."
          echo "## ðŸ”’ RelatÃ³rio de SeguranÃ§a - $(date)" >> security-report.md
          echo "" >> security-report.md
          echo "### ðŸ” Status das AnÃ¡lises:" >> security-report.md
          echo "- AnÃ¡lise de SeguranÃ§a: ${{ needs.security-analysis.result }}" >> security-report.md
          echo "- AnÃ¡lise de Qualidade: ${{ needs.quality-analysis.result }}" >> security-report.md
          echo "- Testes de SeguranÃ§a: ${{ needs.security-tests.result }}" >> security-report.md
          echo "" >> security-report.md
          echo "### ðŸ“ˆ MÃ©tricas:" >> security-report.md
          echo "- Data: $(date)" >> security-report.md
          echo "- Branch: ${{ github.ref_name }}" >> security-report.md
          echo "- Commit: ${{ github.sha }}" >> security-report.md
          echo "- Vulnerabilidades: Verificar logs acima" >> security-report.md
          
      - name: ðŸ“¤ Upload relatÃ³rio
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
          retention-days: 30
