name: üìä Monitoramento Avan√ßado (Manual)

on:
  # ‚ö†Ô∏è ATEN√á√ÉO: Este workflow √© apenas para an√°lises manuais avan√ßadas
  # O monitoramento autom√°tico √© feito pelo health-monitor.yml (executa a cada 30min)
  workflow_dispatch:  # Execu√ß√£o manual quando necess√°rio

env:
  NODE_VERSION: '20'
  FLY_APP_NAME: goldeouro-backend-v2
  BACKEND_URL: https://goldeouro-backend-v2.fly.dev

jobs:
  # üìä Monitoramento de Performance (An√°lise Profunda)
  performance-monitoring:
    name: üìä Monitoramento de Performance
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: üìä An√°lise de performance frontend
        continue-on-error: true
        run: |
          echo "üìä Analisando performance do frontend..."
          if command -v lighthouse &> /dev/null; then
            lighthouse https://goldeouro.lol --output=json --output-path=./lighthouse-report.json --chrome-flags="--headless" || echo "‚ö†Ô∏è Lighthouse falhou"
            
            # Extrair m√©tricas principais (se arquivo existe)
            if [ -f "lighthouse-report.json" ]; then
              performance=$(cat lighthouse-report.json | jq -r '.categories.performance.score * 100 // 0' 2>/dev/null || echo "0")
              accessibility=$(cat lighthouse-report.json | jq -r '.categories.accessibility.score * 100 // 0' 2>/dev/null || echo "0")
              best_practices=$(cat lighthouse-report.json | jq -r '.categories."best-practices".score * 100 // 0' 2>/dev/null || echo "0")
              seo=$(cat lighthouse-report.json | jq -r '.categories.seo.score * 100 // 0' 2>/dev/null || echo "0")
              
              echo "Performance: ${performance}%"
              echo "Accessibility: ${accessibility}%"
              echo "Best Practices: ${best_practices}%"
              echo "SEO: ${seo}%"
              
              # Alertar se performance < 80
              if command -v bc &> /dev/null && (( $(echo "$performance < 80" | bc -l 2>/dev/null || echo "0") )); then
                echo "‚ö†Ô∏è Performance baixa: ${performance}%"
              fi
            fi
          else
            echo "‚ö†Ô∏è Lighthouse n√£o instalado. Instalando..."
            npm install -g lighthouse || echo "‚ö†Ô∏è Falha ao instalar Lighthouse"
          fi
          
      - name: üìä Monitoramento de recursos
        continue-on-error: true
        run: |
          echo "üìä Monitorando recursos do backend..."
          if [ -z "${{ secrets.FLY_API_TOKEN }}" ]; then
            echo "‚ö†Ô∏è FLY_API_TOKEN n√£o configurado. Pulando verifica√ß√£o de recursos."
            exit 0
          fi
          
          if command -v flyctl &> /dev/null; then
            flyctl status --app ${{ env.FLY_APP_NAME }} || echo "‚ö†Ô∏è N√£o foi poss√≠vel obter status"
          else
            echo "‚ö†Ô∏è Flyctl n√£o instalado"
          fi

  # üìä Monitoramento de Logs (An√°lise Profunda)
  log-monitoring:
    name: üìä Monitoramento de Logs
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: üìä Coletar logs do backend
        continue-on-error: true
        run: |
          echo "üìä Coletando logs do backend..."
          if [ -z "${{ secrets.FLY_API_TOKEN }}" ]; then
            echo "‚ö†Ô∏è FLY_API_TOKEN n√£o configurado. Pulando coleta de logs."
            exit 0
          fi
          
          if command -v flyctl &> /dev/null; then
            flyctl logs --app ${{ env.FLY_APP_NAME }} --lines 100 > backend-logs.txt 2>&1 || echo "‚ö†Ô∏è Falha ao coletar logs"
            echo "‚úÖ Logs coletados"
            
            # Verificar erros (se arquivo existe)
            if [ -f "backend-logs.txt" ]; then
              error_count=$(grep -i "error\|exception\|failed" backend-logs.txt | wc -l || echo "0")
              echo "Erros encontrados: $error_count"
              
              if [ "$error_count" -gt 10 ]; then
                echo "‚ö†Ô∏è Muitos erros encontrados: $error_count"
              fi
            fi
          else
            echo "‚ö†Ô∏è Flyctl n√£o instalado"
          fi
          
      - name: üìä An√°lise de logs
        continue-on-error: true
        run: |
          echo "üìä Analisando logs..."
          if [ -f "backend-logs.txt" ]; then
            echo "Total de linhas: $(wc -l < backend-logs.txt)"
            echo "Erros: $(grep -i "error" backend-logs.txt | wc -l || echo "0")"
            echo "Warnings: $(grep -i "warning" backend-logs.txt | wc -l || echo "0")"
            echo "Info: $(grep -i "info" backend-logs.txt | wc -l || echo "0")"
          else
            echo "‚ö†Ô∏è Arquivo de logs n√£o encontrado"
          fi

  # üìä Relat√≥rio de Monitoramento Avan√ßado
  monitoring-report:
    name: üìä Relat√≥rio de Monitoramento
    runs-on: ubuntu-latest
    needs: [performance-monitoring, log-monitoring]
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: üìä Gerar relat√≥rio
        continue-on-error: true
        run: |
          echo "üìä Gerando relat√≥rio de monitoramento avan√ßado..."
          echo "## üìä Relat√≥rio de Monitoramento Avan√ßado - $(date)" >> monitoring-report.md
          echo "" >> monitoring-report.md
          echo "### üîç Status das An√°lises:" >> monitoring-report.md
          echo "- Monitoramento de Performance: ${{ needs.performance-monitoring.result }}" >> monitoring-report.md
          echo "- Monitoramento de Logs: ${{ needs.log-monitoring.result }}" >> monitoring-report.md
          echo "" >> monitoring-report.md
          echo "### üìà M√©tricas:" >> monitoring-report.md
          echo "- Data: $(date)" >> monitoring-report.md
          echo "- Branch: ${{ github.ref_name }}" >> monitoring-report.md
          echo "- Commit: ${{ github.sha }}" >> monitoring-report.md
          echo "- Backend: https://${{ env.FLY_APP_NAME }}.fly.dev" >> monitoring-report.md
          echo "- Frontend: https://goldeouro.lol" >> monitoring-report.md
          echo "" >> monitoring-report.md
          echo "### ‚ö†Ô∏è NOTA:" >> monitoring-report.md
          echo "Este √© um relat√≥rio de an√°lise avan√ßada manual." >> monitoring-report.md
          echo "Para monitoramento autom√°tico cont√≠nuo, veja o workflow 'Health Monitor'." >> monitoring-report.md
          
      - name: üì§ Upload relat√≥rio
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: monitoring-report-advanced-${{ github.run_number }}
          path: |
            monitoring-report.md
            lighthouse-report.json
            backend-logs.txt
          retention-days: 7
          if-no-files-found: ignore
