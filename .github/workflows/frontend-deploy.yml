name: ğŸ¨ Frontend Deploy (Vercel)

on:
  push:
    branches: [ main, dev ]
    paths:
      - 'goldeouro-player/**'
      - '.github/workflows/frontend-deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'goldeouro-player/**'

env:
  NODE_VERSION: '20'
  VERCEL_PROJECT_ID: goldeouro-player
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

jobs:
  # ğŸ” AnÃ¡lise e Testes do Frontend
  test-frontend:
    name: ğŸ§ª Testes Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: goldeouro-player/package-lock.json
          
      - name: ğŸ“¦ Instalar dependÃªncias frontend
        run: |
          cd goldeouro-player
          npm ci
          echo "âœ… DependÃªncias do frontend instaladas"
          
      - name: ğŸ” AnÃ¡lise de seguranÃ§a frontend
        run: |
          cd goldeouro-player
          npm audit --audit-level=moderate
          echo "âœ… AnÃ¡lise de seguranÃ§a do frontend concluÃ­da"
          
      - name: ğŸ§ª Executar testes frontend
        run: |
          cd goldeouro-player
          if [ -f "tests/frontend-tests.js" ]; then
            npm test
          else
            echo "âš ï¸ Arquivo de testes nÃ£o encontrado, pulando testes"
          fi
          echo "âœ… Testes do frontend executados"
          
      - name: ğŸ” Verificar sintaxe
        run: |
          cd goldeouro-player
          echo "ğŸ” Verificando sintaxe dos componentes..."
          npx eslint src/ --ext .js,.jsx,.ts,.tsx --max-warnings 0 || echo "âš ï¸ Avisos de linting encontrados"
          echo "âœ… VerificaÃ§Ã£o de sintaxe concluÃ­da"
          
      - name: ğŸ—ï¸ Build de teste
        run: |
          cd goldeouro-player
          echo "ğŸ—ï¸ Executando build de teste..."
          npm run build
          echo "âœ… Build de teste concluÃ­do"
          
      - name: ğŸ“Š AnÃ¡lise de bundle
        run: |
          cd goldeouro-player
          echo "ğŸ“Š Analisando tamanho do bundle..."
          ls -la dist/
          echo "âœ… AnÃ¡lise de bundle concluÃ­da"

  # ğŸš€ Deploy para Vercel (ProduÃ§Ã£o)
  deploy-production:
    name: ğŸš€ Deploy ProduÃ§Ã£o
    runs-on: ubuntu-latest
    needs: test-frontend
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: goldeouro-player/package-lock.json
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          cd goldeouro-player
          npm ci
          echo "âœ… DependÃªncias instaladas"
          
      - name: ğŸ—ï¸ Build para produÃ§Ã£o
        run: |
          cd goldeouro-player
          npm run build
          echo "âœ… Build concluÃ­do"
          ls -la dist/
          
      - name: ğŸ” Verificar arquivos crÃ­ticos
        run: |
          cd goldeouro-player
          test -f dist/index.html && echo "âœ… index.html encontrado" || (echo "âŒ index.html nÃ£o encontrado" && exit 1)
          test -f dist/favicon.png && echo "âœ… favicon.png encontrado" || echo "âš ï¸ favicon.png nÃ£o encontrado"
          echo "âœ… VerificaÃ§Ã£o concluÃ­da"
          
      - name: ğŸ” Configurar Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: goldeouro-player
          vercel-args: '--prod --yes'
          
      - name: ğŸ§ª Teste de produÃ§Ã£o
        run: |
          echo "ğŸ§ª Testando deploy de produÃ§Ã£o..."
          sleep 30  # Aguardar deploy
          curl -f https://goldeouro.lol || echo "âš ï¸ Teste de produÃ§Ã£o falhou"
          echo "âœ… Teste de produÃ§Ã£o concluÃ­do"
          
      - name: ğŸ“¢ Notificar sucesso produÃ§Ã£o
        run: |
          echo "ğŸ‰ Deploy de produÃ§Ã£o concluÃ­do!"
          echo "ğŸŒ URL: https://goldeouro.lol"
          echo "ğŸ“Š Status: Online"

  # ğŸ”„ Deploy para desenvolvimento
  deploy-development:
    name: ğŸ”„ Deploy Desenvolvimento
    runs-on: ubuntu-latest
    needs: test-frontend
    if: github.ref == 'refs/heads/dev'
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: goldeouro-player/package-lock.json
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          cd goldeouro-player
          npm ci
          echo "âœ… DependÃªncias instaladas"
          
      - name: ğŸ” Configurar Vercel (Dev)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: goldeouro-player
          vercel-args: '--target preview'
          
      - name: ğŸ“¢ Notificar deploy dev
        run: |
          echo "ğŸ”„ Deploy de desenvolvimento concluÃ­do!"
          echo "ğŸŒ URL: Preview disponÃ­vel no Vercel"
          echo "ğŸ“Š Status: Ambiente de desenvolvimento"

  # ğŸ“± Build APK Android
  build-android:
    name: ğŸ“± Build APK
    runs-on: ubuntu-latest
    needs: test-frontend
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: goldeouro-player/package-lock.json
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          cd goldeouro-player
          npm ci
          echo "âœ… DependÃªncias instaladas"
          
      - name: ğŸ—ï¸ Build para produÃ§Ã£o
        run: |
          cd goldeouro-player
          npm run build
          echo "âœ… Build concluÃ­do"
          
      - name: ğŸ“± Gerar APK
        run: |
          cd goldeouro-player
          if [ -d "android" ]; then
            echo "ğŸ“± Gerando APK..."
            npm run build:android || echo "âš ï¸ Build APK falhou"
          else
            echo "âš ï¸ DiretÃ³rio Android nÃ£o encontrado"
          fi
          echo "âœ… Processo APK concluÃ­do"
          
      - name: ğŸ“¦ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: goldeouro-apk
          path: goldeouro-player/android/app/build/outputs/apk/
          retention-days: 30
