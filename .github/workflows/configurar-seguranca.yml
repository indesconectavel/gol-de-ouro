name: ðŸ”’ Configurar SeguranÃ§a AutomÃ¡tica

on:
  workflow_dispatch:  # ExecuÃ§Ã£o manual
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/configurar-seguranca.yml'

permissions:
  contents: write
  administration: write  # NecessÃ¡rio para configurar Branch Protection
  security-events: write  # NecessÃ¡rio para Secret Scanning
  # Nota: Essas permissÃµes podem nÃ£o ser suficientes em repositÃ³rios pÃºblicos
  # Se falhar, configure manualmente via GitHub Settings

jobs:
  configurar-branch-protection:
    name: ðŸ”’ Configurar Branch Protection
    runs-on: ubuntu-latest
    timeout-minutes: 5
    continue-on-error: true  # NÃ£o falhar workflow se nÃ£o conseguir configurar
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v6
      
      - name: ðŸ”’ Configurar Branch Protection Rules
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = 'indesconectavel';
            const repo = 'gol-de-ouro';
            const branch = 'main';
            
            try {
              // Configurar Branch Protection
              await github.rest.repos.updateBranchProtection({
                owner: owner,
                repo: repo,
                branch: branch,
                required_status_checks: {
                  strict: true,
                  contexts: [
                    'CI',
                    'Testes Automatizados',
                    'SeguranÃ§a e Qualidade'
                  ]
                },
                enforce_admins: false, // NÃ£o aplicar para administradores
                required_pull_request_reviews: {
                  required_approving_review_count: 1,
                  dismiss_stale_reviews: true,
                  require_code_owner_reviews: false
                },
                restrictions: null, // Permitir que todos possam criar PRs
                allow_force_pushes: false,
                allow_deletions: false,
                required_linear_history: false
              });
              
              console.log('âœ… Branch Protection Rules configuradas com sucesso!');
              console.log(`   Branch: ${branch}`);
              console.log(`   Required approvals: 1`);
              console.log(`   Status checks: CI, Testes Automatizados, SeguranÃ§a e Qualidade`);
            } catch (error) {
              if (error.status === 404) {
                console.log('âš ï¸ Branch Protection nÃ£o pode ser configurada (requer permissÃµes de administrador)');
                console.log('ðŸ’¡ Configure manualmente: https://github.com/indesconectavel/gol-de-ouro/settings/branches');
                // NÃ£o falhar o workflow - apenas avisar
              } else if (error.status === 403) {
                console.log('âš ï¸ Token nÃ£o tem permissÃµes suficientes');
                console.log('ðŸ’¡ Configure manualmente: https://github.com/indesconectavel/gol-de-ouro/settings/branches');
                // NÃ£o falhar o workflow - apenas avisar
              } else {
                console.log('âš ï¸ Erro ao configurar Branch Protection:', error.message);
                console.log('ðŸ’¡ Isso Ã© normal - Branch Protection precisa ser configurada manualmente');
                console.log('ðŸ’¡ Configure manualmente: https://github.com/indesconectavel/gol-de-ouro/settings/branches');
                // NÃ£o falhar o workflow - apenas avisar
              }
            }

  configurar-secret-scanning:
    name: ðŸ” Habilitar Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 5
    continue-on-error: true  # NÃ£o falhar workflow se nÃ£o conseguir habilitar
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v6
      
      - name: ðŸ” Habilitar Secret Scanning
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = 'indesconectavel';
            const repo = 'gol-de-ouro';
            
            try {
              // Habilitar Vulnerability Alerts (inclui Secret Scanning)
              await github.rest.repos.enableVulnerabilityAlerts({
                owner: owner,
                repo: repo
              });
              
              console.log('âœ… Secret Scanning habilitado com sucesso!');
            } catch (error) {
              if (error.status === 404 || error.status === 403) {
                console.log('âš ï¸ Secret Scanning nÃ£o pode ser habilitado via API');
                console.log('ðŸ’¡ Isso Ã© normal - Secret Scanning precisa ser habilitado manualmente');
                console.log('ðŸ’¡ Configure manualmente: https://github.com/indesconectavel/gol-de-ouro/settings/security');
                console.log('   Role atÃ© "Code security and analysis" e clique em "Enable" em "Secret scanning"');
              } else {
                console.log('âš ï¸ Erro ao habilitar Secret Scanning:', error.message);
                console.log('ðŸ’¡ Isso Ã© normal - Secret Scanning precisa ser habilitado manualmente');
                // NÃ£o falhar o workflow se nÃ£o conseguir habilitar
              }
            }

  verificar-configuracao:
    name: âœ… Verificar ConfiguraÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [configurar-branch-protection, configurar-secret-scanning]
    if: always()  # Executar mesmo se jobs anteriores falharem
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v6
      
      - name: âœ… Verificar Branch Protection
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = 'indesconectavel';
            const repo = 'gol-de-ouro';
            const branch = 'main';
            
            try {
              const protection = await github.rest.repos.getBranchProtection({
                owner: owner,
                repo: repo,
                branch: branch
              });
              
              console.log('âœ… Branch Protection estÃ¡ configurada!');
              console.log(`   Required approvals: ${protection.data.required_pull_request_reviews?.required_approving_review_count || 0}`);
              console.log(`   Force pushes: ${protection.data.allow_force_pushes ? 'Permitido' : 'Bloqueado'}`);
              console.log(`   Deletions: ${protection.data.allow_deletions ? 'Permitido' : 'Bloqueado'}`);
            } catch (error) {
              if (error.status === 404) {
                console.log('âš ï¸ Branch Protection nÃ£o estÃ¡ configurada');
                console.log('ðŸ’¡ Isso Ã© normal - Branch Protection precisa ser configurada manualmente');
                console.log('ðŸ’¡ Configure manualmente: https://github.com/indesconectavel/gol-de-ouro/settings/branches');
              } else {
                console.log('âš ï¸ Erro ao verificar Branch Protection:', error.message);
                console.log('ðŸ’¡ Isso Ã© normal - Verifique manualmente em Settings > Branches');
              }
            }
      
      - name: âœ… Verificar Secret Scanning
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = 'indesconectavel';
            const repo = 'gol-de-ouro';
            
            try {
              const repoInfo = await github.rest.repos.get({
                owner: owner,
                repo: repo
              });
              
              const secretScanning = repoInfo.data.security_and_analysis?.secret_scanning?.status;
              
              if (secretScanning === 'enabled') {
                console.log('âœ… Secret Scanning estÃ¡ habilitado!');
              } else {
                console.log('âš ï¸ Secret Scanning nÃ£o estÃ¡ habilitado');
                console.log('ðŸ’¡ Configure manualmente: https://github.com/indesconectavel/gol-de-ouro/settings/security');
              }
            } catch (error) {
              console.log('âš ï¸ Erro ao verificar Secret Scanning:', error.message);
              console.log('ðŸ’¡ Isso Ã© normal - Verifique manualmente em Settings > Security');
            }
      
      - name: ðŸ“Š Resumo
        run: |
          echo "## ðŸ”’ Resumo da ConfiguraÃ§Ã£o de SeguranÃ§a" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… ConfiguraÃ§Ãµes Aplicadas:" >> $GITHUB_STEP_SUMMARY
          echo "- Branch Protection Rules" >> $GITHUB_STEP_SUMMARY
          echo "- Secret Scanning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ PrÃ³ximos Passos:" >> $GITHUB_STEP_SUMMARY
          echo "1. Verificar Branch Protection: https://github.com/indesconectavel/gol-de-ouro/settings/branches" >> $GITHUB_STEP_SUMMARY
          echo "2. Verificar Secret Scanning: https://github.com/indesconectavel/gol-de-ouro/settings/security" >> $GITHUB_STEP_SUMMARY
          echo "3. Configurar notificaÃ§Ãµes: https://github.com/settings/notifications" >> $GITHUB_STEP_SUMMARY

