<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Atualizando Gol de Ouro...</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #001a33 0%, #003366 100%);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      text-align: center;
    }
    .container {
      max-width: 500px;
      padding: 2rem;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #ffd700;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .log {
      background: rgba(0, 0, 0, 0.3);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 2rem;
      font-family: monospace;
      font-size: 0.875rem;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
    }
    .log-item {
      margin: 0.25rem 0;
      color: #ffd700;
    }
    .log-item.success {
      color: #4ade80;
    }
    .log-item.error {
      color: #f87171;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚öΩ Atualizando Gol de Ouro...</h1>
    <div class="spinner"></div>
    <p>Removendo vers√µes antigas e carregando a vers√£o mais recente...</p>
    <div id="log" class="log"></div>
  </div>

  <script>
    (function() {
      'use strict';
      
      const log = document.getElementById('log');
      let logCount = 0;
      
      function addLog(message, type = 'info') {
        logCount++;
        const item = document.createElement('div');
        item.className = `log-item ${type}`;
        item.textContent = `[${logCount}] ${message}`;
        log.appendChild(item);
        log.scrollTop = log.scrollHeight;
      }
      
      addLog('Iniciando remo√ß√£o for√ßada de Service Workers...', 'info');
      
      // Fun√ß√£o para limpar tudo
      async function cleanupEverything() {
        try {
          // 1. Desregistrar todos os Service Workers
          if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            addLog(`Encontrados ${registrations.length} Service Workers`, 'info');
            
            for (const registration of registrations) {
              addLog(`Desregistrando: ${registration.scope}`, 'info');
              const success = await registration.unregister();
              if (success) {
                addLog(`‚úÖ Service Worker desregistrado: ${registration.scope}`, 'success');
              } else {
                addLog(`‚ö†Ô∏è Falha ao desregistrar: ${registration.scope}`, 'error');
              }
            }
          }
          
          // 2. Limpar todos os caches
          if (caches && caches.keys) {
            const cacheNames = await caches.keys();
            addLog(`Encontrados ${cacheNames.length} caches`, 'info');
            
            for (const cacheName of cacheNames) {
              addLog(`Deletando cache: ${cacheName}`, 'info');
              const deleted = await caches.delete(cacheName);
              if (deleted) {
                addLog(`‚úÖ Cache deletado: ${cacheName}`, 'success');
              }
            }
          }
          
          // 3. Limpar storage
          try {
            sessionStorage.clear();
            localStorage.clear();
            addLog('‚úÖ Storage limpo', 'success');
          } catch (e) {
            addLog(`‚ö†Ô∏è Erro ao limpar storage: ${e.message}`, 'error');
          }
          
          // 4. For√ßar backend correto
          try {
            sessionStorage.setItem('API_BASE_URL', 'https://goldeouro-backend-v2.fly.dev');
            localStorage.setItem('API_BASE_URL', 'https://goldeouro-backend-v2.fly.dev');
            addLog('‚úÖ Backend for√ßado para produ√ß√£o', 'success');
          } catch (e) {
            addLog(`‚ö†Ô∏è Erro ao for√ßar backend: ${e.message}`, 'error');
          }
          
          addLog('‚úÖ Limpeza completa!', 'success');
          return true;
        } catch (error) {
          addLog(`‚ùå Erro durante limpeza: ${error.message}`, 'error');
          return false;
        }
      }
      
      // Executar limpeza e redirecionar
      cleanupEverything().then((success) => {
        addLog('Redirecionando para a p√°gina principal...', 'info');
        
        // Aguardar um pouco para garantir que tudo foi limpo
        setTimeout(() => {
          // ‚úÖ CORRE√á√ÉO: Verificar se est√° em desenvolvimento local
          const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
          const timestamp = Date.now();
          
          if (isLocalhost) {
            // Em desenvolvimento, redirecionar sem par√¢metros desnecess√°rios
            console.log('[KILL-SW] ‚úÖ Desenvolvimento local - redirecionando sem par√¢metros');
            window.location.replace('/');
          } else {
            // Em produ√ß√£o, usar par√¢metros para garantir bypass de cache
            console.log('[KILL-SW] üö® Produ√ß√£o - redirecionando com bypass de cache');
            window.location.replace(`/?nocache=${timestamp}&sw-cleared=true&t=${timestamp}`);
          }
          
          // ‚úÖ FALLBACK: Se n√£o redirecionar em 3 segundos, for√ßar reload completo
          setTimeout(() => {
            if (isLocalhost) {
              window.location.href = '/';
            } else {
              window.location.href = `/?nocache=${Date.now()}&force-reload=true`;
            }
          }, 3000);
        }, 2000);
      });
    })();
  </script>
</body>
</html>
