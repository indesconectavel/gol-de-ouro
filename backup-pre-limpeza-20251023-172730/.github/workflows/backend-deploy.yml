name: ğŸš€ Backend Deploy (Fly.io)

on:
  push:
    branches: [ main, dev ]
    paths:
      - 'server-fly.js'
      - 'package.json'
      - 'package-lock.json'
      - 'Dockerfile'
      - 'fly.toml'
      - 'config/**'
      - 'controllers/**'
      - 'middlewares/**'
      - 'services/**'
      - 'scripts/**'
      - '.github/workflows/backend-deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'server-fly.js'
      - 'package.json'
      - 'package-lock.json'
      - 'Dockerfile'
      - 'fly.toml'
      - 'config/**'
      - 'controllers/**'
      - 'middlewares/**'
      - 'services/**'
      - 'scripts/**'

env:
  NODE_VERSION: '20'
  FLY_APP_NAME: goldeouro-backend

jobs:
  # ğŸ” AnÃ¡lise de CÃ³digo e Testes
  test-and-analyze:
    name: ğŸ§ª Testes e AnÃ¡lise
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          echo "âœ… DependÃªncias instaladas"
          
      - name: ğŸ” AnÃ¡lise de seguranÃ§a
        run: |
          npm audit --audit-level=moderate
          echo "âœ… AnÃ¡lise de seguranÃ§a concluÃ­da"
          
      - name: ğŸ§ª Executar testes
        run: |
          if [ -f "tests/backend-tests.js" ]; then
            npm test
          else
            echo "âš ï¸ Arquivo de testes nÃ£o encontrado, pulando testes"
          fi
          echo "âœ… Testes executados"
          
      - name: ğŸ“Š AnÃ¡lise de qualidade
        run: |
          echo "ğŸ” Verificando sintaxe..."
          node -c server-fly.js
          echo "âœ… Sintaxe vÃ¡lida"
          
          echo "ğŸ” Verificando estrutura..."
          if [ -f "package.json" ] && [ -f "server-fly.js" ] && [ -f "fly.toml" ]; then
            echo "âœ… Estrutura vÃ¡lida"
          else
            echo "âŒ Estrutura invÃ¡lida"
            exit 1
          fi

  # ğŸš€ Deploy para Fly.io
  deploy-backend:
    name: ğŸš€ Deploy Backend
    runs-on: ubuntu-latest
    needs: test-and-analyze
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          echo "âœ… DependÃªncias instaladas"
          
      - name: ğŸ” Configurar Fly.io
        uses: superfly/flyctl-actions/setup-flyctl@master
        
      - name: ğŸš€ Deploy para Fly.io
        run: |
          echo "ğŸš€ Iniciando deploy para Fly.io..."
          flyctl deploy --remote-only --no-cache
          echo "âœ… Deploy concluÃ­do"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          
      - name: ğŸ” Verificar deploy
        run: |
          echo "ğŸ” Verificando status do deploy..."
          flyctl status --app ${{ env.FLY_APP_NAME }}
          echo "âœ… VerificaÃ§Ã£o concluÃ­da"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          
      - name: ğŸ“Š Logs do deploy
        run: |
          echo "ğŸ“Š Coletando logs..."
          flyctl logs --app ${{ env.FLY_APP_NAME }} --lines 50
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          
      - name: ğŸ§ª Teste de saÃºde
        run: |
          echo "ğŸ§ª Testando endpoint de saÃºde..."
          sleep 30  # Aguardar deploy
          curl -f https://${{ env.FLY_APP_NAME }}.fly.dev/health || exit 1
          echo "âœ… Endpoint de saÃºde funcionando"
          
      - name: ğŸ“¢ Notificar sucesso
        run: |
          echo "ğŸ‰ Deploy do backend concluÃ­do com sucesso!"
          echo "ğŸŒ URL: https://${{ env.FLY_APP_NAME }}.fly.dev"
          echo "ğŸ“Š Status: Online"

  # ğŸ”„ Deploy para desenvolvimento
  deploy-dev:
    name: ğŸ”„ Deploy Dev
    runs-on: ubuntu-latest
    needs: test-and-analyze
    if: github.ref == 'refs/heads/dev'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          echo "âœ… DependÃªncias instaladas"
          
      - name: ğŸ” Configurar Fly.io
        uses: superfly/flyctl-actions/setup-flyctl@master
        
      - name: ğŸš€ Deploy para desenvolvimento
        run: |
          echo "ğŸ”„ Deploy para ambiente de desenvolvimento..."
          flyctl deploy --remote-only --no-cache
          echo "âœ… Deploy de desenvolvimento concluÃ­do"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          
      - name: ğŸ“¢ Notificar deploy dev
        run: |
          echo "ğŸ”„ Deploy de desenvolvimento concluÃ­do!"
          echo "ğŸŒ URL: https://${{ env.FLY_APP_NAME }}.fly.dev"
          echo "ğŸ“Š Status: Ambiente de desenvolvimento"
