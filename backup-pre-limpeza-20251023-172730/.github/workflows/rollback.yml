name: ‚ö†Ô∏è Rollback Autom√°tico ‚Äì Gol de Ouro

on:
  workflow_run:
    workflows: ["üöÄ Pipeline Principal - Gol de Ouro"]
    types:
      - completed

jobs:
  rollback:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: üîÑ Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configurar Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: ‚öôÔ∏è Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üîÅ Rollback Backend (Fly.io)
        run: |
          echo "‚ö†Ô∏è Deploy do backend falhou. Iniciando rollback..."
          flyctl releases --app goldeouro-backend
          LAST_RELEASE=$(flyctl releases --app goldeouro-backend | awk 'NR==2{print $1}')
          flyctl deploy --app goldeouro-backend --image-release $LAST_RELEASE
          echo "‚úÖ Rollback do backend conclu√≠do com sucesso."
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: üîÅ Rollback Frontend (Vercel)
        run: |
          echo "‚ö†Ô∏è Deploy do frontend falhou. Revertendo para vers√£o anterior..."
          npx vercel rollback ${{ secrets.VERCEL_PROJECT_ID }} --token=${{ secrets.VERCEL_TOKEN }}
          echo "‚úÖ Rollback do frontend conclu√≠do com sucesso."

      - name: üßæ Registrar logs
        run: |
          mkdir -p docs/logs
          echo "Rollback executado em $(date)" >> docs/logs/rollback-history.log
          echo "Workflow com falha: ${{ github.event.workflow_run.name }}" >> docs/logs/rollback-history.log
          echo "Conclus√£o: ${{ github.event.workflow_run.conclusion }}" >> docs/logs/rollback-history.log
          echo "---" >> docs/logs/rollback-history.log

      - name: üì¢ Notificar via Slack/Discord (opcional)
        if: env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"‚ö†Ô∏è Rollback executado automaticamente no projeto Gol de Ouro. √öltima vers√£o restaurada com sucesso.\"}" \
          $SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
