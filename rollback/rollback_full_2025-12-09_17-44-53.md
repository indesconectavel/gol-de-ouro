# üîÑ GUIA COMPLETO DE ROLLBACK - ENGINE V19
## Data: 2025-12-09_17-44-53

---

## ‚ö†Ô∏è IMPORTANTE

**Execute rollback APENAS se necess√°rio reverter mudan√ßas da Migration V19.**

**Ordem de execu√ß√£o:**
1. Rollback do banco (se migration foi aplicada)
2. Rollback do c√≥digo (se c√≥digo foi modificado)
3. Verifica√ß√µes de integridade

---

## üìã PASSO 1: ROLLBACK DO BANCO

### 1.1 Backup Atual do Banco

**ANTES de executar rollback, crie um backup do estado atual:**

1. Acesse Supabase Dashboard
2. Settings > Database > Backups
3. Crie um backup completo

### 1.2 Executar Rollback SQL

**Arquivo:** `rollback/rollback_banco_2025-12-09_17-44-53.sql`

**Passos:**
1. Acessar Supabase Dashboard
2. Abrir SQL Editor
3. Copiar conte√∫do de `rollback_banco_2025-12-09_17-44-53.sql`
4. Colar no SQL Editor
5. Executar (RUN)
6. Verificar mensagens de sucesso

### 1.3 Verifica√ß√µes P√≥s-Rollback

Execute estas queries para verificar:

```sql
-- Verificar RLS desabilitado
SELECT tablename, rowsecurity FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename IN ('usuarios', 'chutes', 'lotes', 'transacoes');

-- Verificar policies removidas
SELECT COUNT(*) FROM pg_policies WHERE schemaname = 'public';

-- Verificar system_heartbeat removida
SELECT COUNT(*) FROM information_schema.tables 
WHERE table_schema = 'public' AND table_name = 'system_heartbeat';
```

**Resultado Esperado:**
- ‚úÖ RLS desabilitado em todas as tabelas
- ‚úÖ Policies removidas (ou reduzidas)
- ‚úÖ system_heartbeat n√£o existe

---

## üìã PASSO 2: ROLLBACK DO C√ìDIGO

### 2.1 Windows (PowerShell)

**Arquivo:** `rollback/rollback_codigo_2025-12-09_17-44-53.ps1`

**Comando:**
```powershell
cd "E:\Chute de Ouro\goldeouro-backend"
.\rollback\rollback_codigo_2025-12-09_17-44-53.ps1
```

### 2.2 Linux/Mac (Bash)

**Arquivo:** `rollback/rollback_codigo_2025-12-09_17-44-53.sh`

**Comando:**
```bash
cd /path/to/goldeouro-backend
chmod +x rollback/rollback_codigo_2025-12-09_17-44-53.sh
./rollback/rollback_codigo_2025-12-09_17-44-53.sh
```

### 2.3 Restaura√ß√£o Manual

Ap√≥s extrair o backup:

1. Comparar arquivos extra√≠dos com projeto atual
2. Restaurar apenas arquivos que foram modificados
3. Verificar integridade ap√≥s restaura√ß√£o

---

## üìã PASSO 3: VERIFICA√á√ïES DE INTEGRIDADE

### 3.1 Verificar Hashes

**Arquivo:** `backups/codigo/backup_codigo_2025-12-09_17-44-53.zip` (dentro do ZIP: `hashes_sha256.txt`)

**Comando:**
```bash
# Extrair hashes do ZIP
unzip -p backups/codigo/backup_codigo_2025-12-09_17-44-53.zip hashes_sha256.txt > hashes_original.txt

# Calcular hashes atuais
find src database controllers services routes -type f -exec sha256sum {} \; > hashes_atual.txt

# Comparar
diff hashes_original.txt hashes_atual.txt
```

### 3.2 Verificar Servidor

**Comando:**
```bash
node server-fly.js
```

**Verificar:**
- ‚úÖ Servidor inicia sem erros
- ‚úÖ Rotas registradas corretamente
- ‚úÖ Conex√£o com banco funciona

### 3.3 Verificar Endpoints

**Endpoints a Testar:**
- `GET /health` - Deve retornar HTTP 200
- `GET /api/admin/stats` - Deve funcionar (com token)
- `POST /api/games/shoot` - Deve funcionar (com autentica√ß√£o)

---

## üìã PASSO 4: VALIDA√á√ÉO FINAL

### Checklist de Valida√ß√£o

- [ ] Banco restaurado ao estado anterior
- [ ] C√≥digo restaurado ao estado anterior
- [ ] Servidor inicia sem erros
- [ ] Endpoints funcionando
- [ ] Hashes verificados
- [ ] Sem erros nos logs

---

## üö® EM CASO DE PROBLEMAS

### Problema: Rollback SQL falhou

**Solu√ß√£o:**
1. Verificar logs do Supabase
2. Executar queries de rollback uma por uma
3. Verificar constraints e depend√™ncias

### Problema: C√≥digo n√£o restaura

**Solu√ß√£o:**
1. Verificar permiss√µes de arquivos
2. Restaurar manualmente arquivo por arquivo
3. Verificar se backup ZIP est√° √≠ntegro

### Problema: Servidor n√£o inicia ap√≥s rollback

**Solu√ß√£o:**
1. Verificar logs do servidor
2. Verificar depend√™ncias (npm install)
3. Verificar vari√°veis de ambiente

---

## üìû SUPORTE

**Arquivos de Refer√™ncia:**
- Backup c√≥digo: `backups/codigo/backup_codigo_2025-12-09_17-44-53.zip`
- Backup banco: `backups/banco/backup_banco_2025-12-09_17-44-53.sql`
- Estrutura banco: `backups/banco/estrutura_atual_2025-12-09_17-44-53.json`

**Documenta√ß√£o:**
- Relat√≥rio backup: `backups/RELATORIO-BACKUP-COMPLETO-V19.md`
- Auditoria t√©cnica: `AUDITORIA-TECNICA-COMPLETA-V19.md`

---

**Gerado em:** 2025-12-09_17-44-53  
**Vers√£o:** V19.0.0
