{
  "auditoria": {
    "versao": "V19.0.0",
    "data": "2025-12-10",
    "auditor": "AUDITOR SUPREMO V19 - STATE SCAN",
    "tipo": "VERIFICACAO DE INTEGRIDADE COMPLETA"
  },
  "componentes_faltando": {
    "rpc_functions": {
      "financeiras": [
        {
          "nome": "rpc_add_balance",
          "status": "REQUER_VERIFICACAO",
          "arquivo": "database/rpc-financial-acid.sql",
          "usada_por": [
            "src/modules/financial/services/financial.service.js:44",
            "src/modules/financial/services/webhook.service.js:367",
            "src/modules/rewards/services/reward.service.js:78"
          ],
          "impacto": "CRITICO - Sistema financeiro não funcionará"
        },
        {
          "nome": "rpc_deduct_balance",
          "status": "REQUER_VERIFICACAO",
          "arquivo": "database/rpc-financial-acid.sql",
          "usada_por": [
            "src/modules/financial/services/financial.service.js:120",
            "src/modules/game/controllers/game.controller.js:289"
          ],
          "impacto": "CRITICO - Sistema financeiro não funcionará"
        },
        {
          "nome": "rpc_transfer_balance",
          "status": "REQUER_VERIFICACAO",
          "arquivo": "database/rpc-financial-acid.sql",
          "usada_por": [
            "src/modules/financial/services/financial.service.js:214"
          ],
          "impacto": "MEDIO - Transferências não funcionarão"
        },
        {
          "nome": "rpc_get_balance",
          "status": "REQUER_VERIFICACAO",
          "arquivo": "database/rpc-financial-acid.sql",
          "usada_por": [
            "src/modules/financial/services/financial.service.js:277"
          ],
          "impacto": "MEDIO - Consultas de saldo podem falhar"
        }
      ],
      "recompensas": [
        {
          "nome": "rpc_register_reward",
          "status": "REQUER_VERIFICACAO",
          "arquivo": "database/schema-rewards.sql",
          "usada_por": [
            "src/modules/rewards/services/reward.service.js:49"
          ],
          "impacto": "CRITICO - Sistema de recompensas não funcionará"
        },
        {
          "nome": "rpc_mark_reward_credited",
          "status": "REQUER_VERIFICACAO",
          "arquivo": "database/schema-rewards.sql",
          "usada_por": [
            "src/modules/rewards/services/reward.service.js:92",
            "src/modules/rewards/services/reward.service.js:109"
          ],
          "impacto": "CRITICO - Sistema de recompensas não funcionará"
        },
        {
          "nome": "rpc_get_user_rewards",
          "status": "REQUER_VERIFICACAO",
          "arquivo": "database/schema-rewards.sql",
          "usada_por": [
            "src/modules/rewards/services/reward.service.js:154"
          ],
          "impacto": "BAIXO - Histórico de recompensas não funcionará"
        }
      ],
      "webhook": [
        {
          "nome": "rpc_register_webhook_event",
          "status": "REQUER_VERIFICACAO",
          "arquivo": "database/schema-webhook-events.sql",
          "usada_por": [
            "src/modules/financial/services/webhook.service.js:50"
          ],
          "impacto": "CRITICO - Idempotência de webhook não funcionará"
        },
        {
          "nome": "rpc_check_webhook_event_processed",
          "status": "REQUER_VERIFICACAO",
          "arquivo": "database/schema-webhook-events.sql",
          "usada_por": [
            "src/modules/financial/services/webhook.service.js:106"
          ],
          "impacto": "CRITICO - Idempotência de webhook não funcionará"
        },
        {
          "nome": "rpc_mark_webhook_event_processed",
          "status": "REQUER_VERIFICACAO",
          "arquivo": "database/schema-webhook-events.sql",
          "usada_por": [
            "src/modules/financial/services/webhook.service.js:152",
            "src/modules/financial/services/webhook.service.js:201"
          ],
          "impacto": "CRITICO - Idempotência de webhook não funcionará"
        }
      ],
      "lotes": [
        {
          "nome": "rpc_get_or_create_lote",
          "status": "REQUER_VERIFICACAO",
          "arquivo": "database/schema-lotes-persistencia.sql",
          "migration_v19": true,
          "usada_por": [
            "src/modules/lotes/services/lote.service.js:25",
            "src/modules/lotes/lote.service.db.js:31"
          ],
          "impacto": "CRITICO - Sistema de lotes não funcionará"
        },
        {
          "nome": "rpc_update_lote_after_shot",
          "status": "REQUER_VERIFICACAO",
          "arquivo": "database/schema-lotes-persistencia.sql",
          "migration_v19": true,
          "usada_por": [
            "src/modules/lotes/services/lote.service.js:75",
            "src/modules/lotes/lote.service.db.js:91",
            "src/modules/game/controllers/game.controller.js:442"
          ],
          "impacto": "CRITICO - Sistema de lotes não funcionará"
        },
        {
          "nome": "rpc_get_active_lotes",
          "status": "REQUER_VERIFICACAO",
          "arquivo": "database/schema-lotes-persistencia.sql",
          "migration_v19": false,
          "usada_por": [
            "src/modules/lotes/services/lote.service.js:118"
          ],
          "impacto": "MEDIO - Sincronização de lotes pode não funcionar"
        }
      ],
      "outras": [
        {
          "nome": "expire_stale_pix",
          "status": "REQUER_VERIFICACAO",
          "arquivo": "database/rpc-expire-stale-pix.sql",
          "usada_por": [
            "src/modules/admin/controllers/admin.controller.js:500",
            "server-fly.js:836"
          ],
          "impacto": "BAIXO - Expiração automática de PIX pode não funcionar"
        }
      ]
    },
    "tabelas": {
      "system_heartbeat": {
        "status": "REQUER_VERIFICACAO",
        "esperada": true,
        "migration_v19": true,
        "usada_por": [
          "src/scripts/heartbeat_sender.js:14",
          "src/modules/monitor/monitor.controller.js"
        ],
        "impacto": "CRITICO - Monitoramento V19 não funcionará"
      },
      "metricas_globais": {
        "status": "REQUER_VERIFICACAO",
        "esperada": true,
        "migration_v19": false,
        "usada_por": [
          "server-fly.js:856"
        ],
        "impacto": "MEDIO - Contador global pode não funcionar"
      }
    },
    "colunas": {
      "lotes": {
        "persisted_global_counter": {
          "status": "REQUER_VERIFICACAO",
          "migration_v19": true,
          "impacto": "MEDIO - Persistência de contador pode não funcionar"
        },
        "synced_at": {
          "status": "REQUER_VERIFICACAO",
          "migration_v19": true,
          "impacto": "BAIXO - Sincronização pode não funcionar"
        },
        "posicao_atual": {
          "status": "REQUER_VERIFICACAO",
          "migration_v19": true,
          "impacto": "CRITICO - Sistema de lotes não funcionará"
        }
      },
      "transacoes": {
        "referencia_id": {
          "status": "REQUER_VERIFICACAO",
          "corrigido": "2025-12-10",
          "impacto": "CRITICO - RPCs financeiras não funcionarão"
        },
        "referencia_tipo": {
          "status": "REQUER_VERIFICACAO",
          "corrigido": "2025-12-10",
          "impacto": "CRITICO - RPCs financeiras não funcionarão"
        },
        "saldo_anterior": {
          "status": "REQUER_VERIFICACAO",
          "corrigido": "2025-12-10",
          "impacto": "CRITICO - RPCs financeiras não funcionarão"
        },
        "saldo_posterior": {
          "status": "REQUER_VERIFICACAO",
          "corrigido": "2025-12-10",
          "impacto": "CRITICO - RPCs financeiras não funcionarão"
        },
        "metadata": {
          "status": "REQUER_VERIFICACAO",
          "corrigido": "2025-12-10",
          "impacto": "BAIXO - Metadados podem não ser salvos"
        },
        "processed_at": {
          "status": "REQUER_VERIFICACAO",
          "corrigido": "2025-12-10",
          "impacto": "BAIXO - Timestamp de processamento pode não ser salvo"
        }
      }
    }
  },
  "funcoes_sumidas": {
    "status": "NENHUMA_IDENTIFICADA",
    "observacao": "Todas as funções esperadas estão presentes no código"
  },
  "arquivos_sintaxe_quebrada": {
    "status": "VERIFICACAO_PENDENTE",
    "metodo": "Requer execução de linter ou parser",
    "arquivos_suspeitos": []
  },
  "loops_importacao": {
    "status": "NENHUM_IDENTIFICADO",
    "verificacao": {
      "financial.service.js": {
        "importa": [
          "supabase-unified-config",
          "response-helper"
        ],
        "nao_importa": [
          "webhook.service",
          "lote.service",
          "reward.service"
        ],
        "status": "OK"
      },
      "webhook.service.js": {
        "importa": [
          "supabase-unified-config",
          "financial.service"
        ],
        "nao_importa": [
          "lote.service",
          "reward.service"
        ],
        "status": "OK"
      },
      "lote.service.js": {
        "importa": [
          "supabase-unified-config"
        ],
        "nao_importa": [
          "financial.service",
          "webhook.service",
          "reward.service"
        ],
        "status": "OK"
      },
      "reward.service.js": {
        "importa": [
          "supabase-unified-config",
          "financial.service"
        ],
        "nao_importa": [
          "webhook.service",
          "lote.service"
        ],
        "status": "OK"
      },
      "game.controller.js": {
        "importa": [
          "supabase-unified-config",
          "lote.service",
          "reward.service",
          "financial.service",
          "lote-integrity-validator"
        ],
        "nao_importa": [
          "webhook.service"
        ],
        "status": "OK"
      }
    }
  },
  "conflitos_schema": {
    "status": "NENHUM_IDENTIFICADO",
    "observacao": "Schemas SQL estão bem estruturados e idempotentes"
  },
  "variaveis_ambiente_faltando": {
    "criticas": [
      {
        "variavel": "USE_ENGINE_V19",
        "status": "FALTANDO",
        "impacto": "CRITICO - Engine V19 não será ativada",
        "arquivo": "env.example"
      },
      {
        "variavel": "ENGINE_HEARTBEAT_ENABLED",
        "status": "FALTANDO",
        "impacto": "CRITICO - Heartbeat não será iniciado",
        "arquivo": "env.example"
      },
      {
        "variavel": "ENGINE_MONITOR_ENABLED",
        "status": "FALTANDO",
        "impacto": "CRITICO - Monitoramento não será ativado",
        "arquivo": "env.example"
      }
    ],
    "opcionais": [
      {
        "variavel": "USE_DB_QUEUE",
        "status": "FALTANDO",
        "impacto": "BAIXO - Sistema pode não usar fila de banco",
        "arquivo": "env.example"
      },
      {
        "variavel": "HEARTBEAT_INTERVAL_MS",
        "status": "FALTANDO",
        "impacto": "BAIXO - Usa valor padrão",
        "arquivo": "env.example"
      }
    ]
  },
  "imports_quebrados": {
    "status": "NENHUM_IDENTIFICADO",
    "verificacao": {
      "todos_os_imports": "CORRETOS",
      "caminhos_relativos": "CORRETOS",
      "modulos_externos": "CORRETOS"
    }
  },
  "duplicacoes": {
    "controllers": {
      "total": 7,
      "arquivos": [
        "controllers/adminController.js",
        "controllers/authController.js",
        "controllers/gameController.js",
        "controllers/paymentController.js",
        "controllers/systemController.js",
        "controllers/usuarioController.js",
        "controllers/withdrawController.js"
      ],
      "status": "LEGACY_NAO_USADO"
    },
    "services": {
      "total": 4,
      "arquivos": [
        "services/loteService.js",
        "services/financialService.js",
        "services/rewardService.js",
        "services/webhookService.js"
      ],
      "status": "LEGACY_NAO_USADO"
    },
    "routes": {
      "total": 7,
      "arquivos": [
        "routes/adminRoutes.js",
        "routes/authRoutes.js",
        "routes/gameRoutes.js",
        "routes/paymentRoutes.js",
        "routes/systemRoutes.js",
        "routes/usuarioRoutes.js",
        "routes/withdrawRoutes.js"
      ],
      "status": "LEGACY_NAO_USADO"
    }
  },
  "resumo": {
    "componentes_faltando": {
      "rpc_functions": 13,
      "tabelas": 2,
      "colunas": 9
    },
    "funcoes_sumidas": 0,
    "arquivos_sintaxe_quebrada": 0,
    "loops_importacao": 0,
    "conflitos_schema": 0,
    "variaveis_faltando": 5,
    "imports_quebrados": 0,
    "duplicacoes": 18,
    "status_geral": "INTEGRO_COM_RESERVAS",
    "risco": "MEDIO",
    "observacao": "Sistema funcional, mas requer verificação real do banco e aplicação de RPCs separadas"
  }
}

